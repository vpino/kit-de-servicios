#!/bin/bash -e
#
# ==============================================================================
# PAQUETE: kit-servicios
# ARCHIVO: postinst
# DESCRIPCIÓN: Configura el sistema despues la instalación del paquete.
# COPYRIGHT:
#  (C) 2016 Victor Pino <victopin0@gmail.com>
# LICENCIA: GPL3
# ==============================================================================
#
# Este programa es software libre. Puede redistribuirlo y/o modificarlo bajo los
# términos de la Licencia Pública General de GNU (versión 3).


case "$1" in
    configure)

        echo "Colocando /etc/default/celeryd en /etc/kds/diverted/celeryd"
        dpkg-divert --divert /etc/kds/diverted/default/celeryd --rename /etc/default/celeryd

        if [ ! -L  /etc/default/celeryd ] ; then

            echo "Instalando configuracion personalizada para Celeryd default"
            ln /etc/kds/default/celeryd /etc/default/celeryd

        fi

        echo "Colocando /etc/init.d/celeryd en /etc/kds/diverted/init.d/celeryd"
        dpkg-divert --divert /etc/kds/diverted/init.d/celeryd --rename /etc/init.d/celeryd

        if [ ! -L  /etc/init.d/celeryd ] ; then

            echo "Instalando configuracion personalizada para Celeryd init"
            ln /etc/kds/init.d/celeryd /etc/init.d/celeryd

        fi
        
        if [ -f  /var/log/celery ] ; then

            echo "Eliminando los logs"
            rm -rf /var/log/celery

        fi
        
        echo "Creando usuario KDS-CELERY"
        adduser --system --shell /bin/bash --gecos 'KDS-CELERY system user' --group --disabled-password --quiet --no-create-home kds-celery

        echo "Creando usuario KDS"
        adduser --system --shell /bin/bash --gecos 'KDS system user' --group --disabled-password --quiet --home /home/kds kds

        # Source debconf library.
        . /usr/share/debconf/confmodule

        db_get kit-servicios/user_pass
      
        if [ "$RET" ]; then
            echo "kds:$RET" | chpasswd
        else
            echo "kds:k1ts3rv1c10s" | chpasswd
        fi
        
        echo "Generando llave ssh al usuario kds"
        ssh-keygen -t rsa -f /home/kds/.ssh/id_rsa -q -P ""

        /etc/init.d/rabbitmq-server restart

        echo "Configurando rabbitmq-server"

        rabbitmqctl add_user kds 11

        echo "==== add virtual host 'kds_vhost' === "

        rabbitmqctl add_vhost kds_vhost

        echo "==== add user tag 'kds_tag' for user 'kds' ==="

        rabbitmqctl set_user_tags kds kds_tag

        echo "==== set permission for user 'kds' on virtual host 'kds_vhost' ==="

        rabbitmqctl set_permissions -p kds_vhost kds ".*" ".*" ".*"

        echo "Eliminar archivo /etc/nginx/sites-available/default"
        if [ -f /etc/nginx/sites-available/default ] ; then

            rm -rf /etc/nginx/sites-available/default

        fi

        if [ -d /usr/share/python/kit-servicios/ ]; then
        
            echo "Modificando los permisos de la carpeta del proyecto"
            chmod 755 /usr/share/python/kit-servicios/

        fi

        echo "Permisos a la carpeta del proyecto"
        chown -R www-data:www-data /usr/share/python/kit-servicios/lib/python2.7/site-packages/kit-servicios/

        chmod 777 /usr/share/python/kit-servicios/lib/python2.7/site-packages/kit-servicios/ansible.log
        chmod 777 /usr/share/python/kit-servicios/lib/python2.7/site-packages/kit-servicios/playbook-log

        echo "Configurando permisos y grupos de celeryd"
        chmod x+ /etc/init.d/celeryd
        chown root:root /etc/init.d/celeryd
        chmod 777 /etc/init.d/celeryd

        echo "Creando archivos de log de celeryd"
        touch /var/log/celery/w1.log
        touch /var/run/celery/w1.pid

        echo "Reiniciando los servicios"
		service nginx restart
		service uwsgi restart || true
        /etc/init.d/celeryd restart 
        service redis-server restart
      
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

#DEBHELPER#

exit 0
